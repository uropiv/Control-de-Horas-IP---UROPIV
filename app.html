<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control Horas IP — Usuario</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <header class="header">
    <img src="assets/logo.jpg" alt="Policía San Luis" class="logo"/>
    <h1>Control Horas IP — Usuario</h1>
    <div style="margin-left:auto">
      <button id="btn-logout" class="smallbtn">Cerrar sesión</button>
    </div>
  </header>

  <main class="container">
    <section class="box">
      <h2>Bienvenido <span id="user-name">Usuario</span></h2>
      <p class="small">Legajo: <strong id="user-legajo"></strong></p>
<div style="display:flex;gap:10px;flex-wrap:wrap">
  // Add IP (reemplazar handler antiguo)
  document.getElementById("btn-add-ip").addEventListener("click", async () => {
    const btn = document.getElementById("btn-add-ip");
    btn.disabled = true;
    const subtipo = document.getElementById("ip-subtipo").value.trim();
    const fecha = document.getElementById("ip-fecha").value;
    const horas = Number(document.getElementById("ip-horas").value) || 0;
    const obs = document.getElementById("ip-obs").value.trim();
    const outMsg = document.getElementById("msg-add-ip");

    outMsg.textContent = "";
    if(!fecha || horas <= 0){
      outMsg.textContent = "Completa fecha y horas correctamente.";
      btn.disabled = false;
      return;
    }

    try{
      const a = getAuth();
      const res = await api("addService", { token: a.token, legajo: a.legajo, tipo: "IP", subtipo, fecha, horas, observaciones: obs, device: "web" });
      if(res.ok){
        outMsg.textContent = "Horas IP registradas correctamente.";
        // limpiar campos
        document.getElementById("ip-subtipo").value = "";
        document.getElementById("ip-horas").value = "4";
        document.getElementById("ip-obs").value = "";
        // recargar servicios y resumen
        await loadServices();
        // actualizar resumen automáticamente (si lo querés): descomenta la siguiente línea
        // document.getElementById("btn-get-summary").click();
      } else {
        outMsg.textContent = "Error al registrar: " + (res.error || "sin detalle");
      }
    }catch(err){
      outMsg.textContent = "Error de conexión: " + String(err);
    } finally {
      btn.disabled = false;
    }
  });

  // Add Curso (reemplazar handler antiguo)
  document.getElementById("btn-add-curso").addEventListener("click", async () => {
    const btn = document.getElementById("btn-add-curso");
    btn.disabled = true;
    const subtipo = document.getElementById("curso-subtipo").value.trim();
    const fecha = document.getElementById("curso-fecha").value;
    const horas = Number(document.getElementById("curso-horas").value) || 0;
    const obs = document.getElementById("curso-obs").value.trim();
    const outMsg = document.getElementById("msg-add-curso");

    outMsg.textContent = "";
    if(!fecha || horas <= 0){
      outMsg.textContent = "Completa fecha y horas correctamente.";
      btn.disabled = false;
      return;
    }

    try{
      const a = getAuth();
      const res = await api("addService", { token: a.token, legajo: a.legajo, tipo: "CURSO", subtipo, fecha, horas, observaciones: obs, device: "web" });
      if(res.ok){
        outMsg.textContent = "Curso registrado correctamente.";
        // limpiar campos
        document.getElementById("curso-subtipo").value = "";
        document.getElementById("curso-horas").value = "4";
        document.getElementById("curso-obs").value = "";
        // recargar servicios y resumen
        await loadServices();
        // actualizar resumen automáticamente (si lo querés): descomenta la siguiente línea
        // document.getElementById("btn-get-summary").click();
      } else {
        outMsg.textContent = "Error al registrar: " + (res.error || "sin detalle");
      }
    }catch(err){
      outMsg.textContent = "Error de conexión: " + String(err);
    } finally {
      btn.disabled = false;
    }
  });

    </section>

<section class="box">
  <h3>Resumen mensual</h3>
  <label>Año
    <input id="res-year" type="number" min="2020" value="">
  </label>
  <label>Mes
    <select id="res-month"></select>
  </label>
  <div class="actions"><button id="btn-get-summary">Ver resumen</button></div>

  <!-- BARRAS DE PROGRESO -->
  <div id="progress-container" style="margin-top:12px">
    <div class="progress-label"><span>Horas IP</span><span id="label-ip">0 / 40 h</span></div>
    <div class="progress"><span id="bar-ip" class="progress-bar ip" style="width:0%"></span></div>

    <div class="progress-label" style="margin-top:10px;"><span>Horas Cursos</span><span id="label-curso">0 / 40 h</span></div>
    <div class="progress"><span id="bar-curso" class="progress-bar curso" style="width:0%"></span></div>

    <div class="progress-label" style="margin-top:10px;"><span>Total consumido</span><span id="label-total">0 / 40 h</span></div>
    <div class="progress"><span id="bar-total" class="progress-bar total" style="width:0%"></span></div>
  </div>

  <!-- OUTPUT DE RESUMEN DETALLADO -->
  <div id="summary-output" style="margin-top:12px" class="small"></div>
</section>


    <section class="box" style="grid-column:1/-1">
      <h3>Mis servicios registrados</h3>
      <div id="services-list" class="small"></div>
    </section>

<!-- SUGERENCIAS -->
    <section class="box">
  <h3>Mis sugerencias</h3>
  <div id="user-suggestions" class="small">Cargando...</div>
</section>

  </main>

  <footer class="footer"><small>Policía Provincia de San Luis — Control Horas IP</small></footer>

  <script src="js/app-common.js"></script>
  <script src="js/app-page.js"></script>
</body>
</html>
