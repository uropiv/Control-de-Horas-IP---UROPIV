<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema Horas IP - UROP IV</title>
  <style>
    /* estilos compactos (puedes personalizar) */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f0f2f5; margin:0; padding:0; color:#222 }
    header { background:#003366; color:#fff; display:flex; align-items:center; gap:12px; padding:12px 18px; position:sticky; top:0 }
    header img { height:48px }
    header h1 { font-size:1.1rem; margin:0; flex:1; text-align:center }
    nav button { background:#0059b3;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer }
    main { max-width:760px;margin:22px auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.08) }
    input, button, select { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc; box-sizing:border-box }
    .hidden { display:none }
    table { width:100%; border-collapse:collapse; margin-top:12px }
    th,td{ padding:8px;border:1px solid #e4e4e4; text-align:left }
    th { background:#004080;color:#fff }
    .progress-bar { background:#e0e0e0; border-radius:10px; height:20px; overflow:hidden; margin-top:8px }
    .progress-fill { height:100%; width:0%; text-align:center; line-height:20px; color:#fff }
    .small { font-size:.9rem }
  </style>
</head>
<body>
  <header>
    <img src="escudo.png" alt="Escudo Policial" onerror="this.style.display='none'"/>
    <h1>Sistema de Control de Horas IP - UROP IV</h1>
    <nav id="nav">
      <button onclick="mostrarInicio()">Inicio</button>
      <button onclick="mostrarSupervisor()">Supervisor</button>
      <button onclick="cerrarSesion()">Salir</button>
    </nav>
  </header>

  <main>
    <!-- LOGIN -->
    <section id="login-section">
      <h2>Ingreso de Usuario</h2>
      <input id="legajo" type="text" placeholder="Legajo personal" />
      <input id="apellido" type="text" placeholder="Apellido" />
      <input id="nombre" type="text" placeholder="Nombre" />
      <button onclick="login()">Ingresar</button>
    </section>

    <!-- USUARIO -->
    <section id="user-section" class="hidden">
      <h2>Registro de Horas IP</h2>
      <p><strong>Legajo:</strong> <span id="user-legajo"></span></p>
      <input id="fecha" type="date" />
      <input id="horas" type="number" min="0" step="0.5" placeholder="Cantidad de horas (ej: 1.5)" />
      <input id="lugar" type="text" placeholder="Lugar / Actividad" />
      <button onclick="registrarHoras()">Registrar</button>

      <div id="resumen">
        <h3>Resumen de Horas</h3>
        <p class="small"><strong>Total acumulado:</strong> <span id="total-horas">0</span> hs</p>
        <p class="small"><strong>Restantes:</strong> <span id="restantes">40</span> hs</p>
        <div class="progress-bar">
          <div id="progress-fill" class="progress-fill" style="background:#007bff">0%</div>
        </div>
      </div>

      <div id="historial">
        <h3>Historial de Cargas</h3>
        <table>
          <thead><tr><th>Fecha</th><th>Horas</th><th>Lugar / Actividad</th></tr></thead>
          <tbody id="tabla-historial"></tbody>
        </table>
      </div>
    </section>

    <!-- SUPERVISOR -->
    <section id="admin-section" class="hidden">
      <h2>Panel del Supervisor</h2>
      <input id="admin-key" type="password" placeholder="Clave de supervisor" />
      <button onclick="verGeneral()">Ver todos los registros</button>
      <div id="tabla-general" style="margin-top:12px"></div>
    </section>
  </main>

  <script>
    // ********* CONFIGURA ESTA URL con la URL /exec que te dará GAS tras desplegar *********
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzPqZFu4aDzIgQrz7fNCoqDmkAunUGhF7DXEFIRbDuhvyurVMMlXgb6ys4zaWpPDIeSxA/exec";

    const LIMITE_HORAS = 40;
    let userLegajo = "";

    function mostrarInicio(){
      document.getElementById('login-section').classList.remove('hidden');
      document.getElementById('user-section').classList.add('hidden');
      document.getElementById('admin-section').classList.add('hidden');
    }
    function mostrarSupervisor(){
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('user-section').classList.add('hidden');
      document.getElementById('admin-section').classList.remove('hidden');
    }
    function cerrarSesion(){
      location.reload();
    }

    function login(){
      const legajo = document.getElementById('legajo').value.trim();
      const apellido = document.getElementById('apellido').value.trim();
      const nombre = document.getElementById('nombre').value.trim();
      if(!legajo || !apellido || !nombre){ alert('Complete todos los campos.'); return; }
      userLegajo = legajo;
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('user-section').classList.remove('hidden');
      document.getElementById('user-legajo').textContent = legajo;
      // obtener datos (usa GET a GAS)
      obtenerDatosUsuario();
    }

    // Lectura: usamos GET normal (JSON) y fallback JSONP si hay problema
    async function obtenerDatosUsuario(){
      if(!userLegajo) return;
      try {
        // intento con GET JSON normal
        const res = await fetch(`${WEB_APP_URL}?action=getUser&legajo=${encodeURIComponent(userLegajo)}`, { method:'GET', mode:'cors' });
        if(res.ok){
          const data = await res.json();
          if(data && data.status === 'ok'){ renderDatosUsuario(data); return; }
          // si viene otra cosa, intento JSONP (fallback)
        }
      } catch(err){
        // console.warn('GET JSON falló, intento JSONP', err);
      }
      // JSONP fallback (usa callback)
      jsonpGetUser(userLegajo, function(data){
        if(data && data.status === 'ok') renderDatosUsuario(data);
        else alert('Error al obtener datos de usuario.');
      });
    }

    function renderDatosUsuario(data){
      const total = Number(data.total) || 0;
      document.getElementById('total-horas').textContent = total;
      document.getElementById('restantes').textContent = Math.max(0, LIMITE_HORAS - total);
      const porcentaje = Math.min(100, (total / LIMITE_HORAS) * 100);
      const barra = document.getElementById('progress-fill');
      barra.style.width = porcentaje + '%';
      barra.textContent = Math.round(porcentaje) + '%';

      const tbody = document.getElementById('tabla-historial');
      tbody.innerHTML = '';
      (data.registros || []).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.fecha}</td><td>${r.horas}</td><td>${r.lugar}</td>`;
        tbody.appendChild(tr);
      });
    }

    // JSONP helper para GET (fallback CORS)
    function jsonpGetUser(legajo, cb){
      const callbackName = 'cb_' + Math.random().toString(36).slice(2);
      window[callbackName] = function(data){ cb(data); delete window[callbackName]; script.remove(); };
      const script = document.createElement('script');
      script.src = `${WEB_APP_URL}?action=getUser&legajo=${encodeURIComponent(legajo)}&callback=${callbackName}`;
      document.body.appendChild(script);
    }

    // Registrar horas: POST JSON
async function registrarHoras(){
  const fecha = document.getElementById('fecha').value;
  const horas = parseFloat(document.getElementById('horas').value);
  const lugar = document.getElementById('lugar').value.trim();
  const apellido = document.getElementById('apellido').value.trim();
  const nombre = document.getElementById('nombre').value.trim();

  if(!fecha || !horas || !lugar){ alert('Complete todos los campos.'); return; }
  if(horas <= 0){ alert('Horas inválidas.'); return; }

  try {
    // intento POST normal
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      mode:'cors',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ action:'registrar', legajo: userLegajo, apellido, nombre, fecha, horas, lugar })
    });
    const data = await res.json();
    if(data && data.status === 'ok'){
      alert('Horas registradas correctamente.');
      obtenerDatosUsuario();
    } else {
      alert('Error: ' + (data.message || 'Respuesta inválida'));
    }
  } catch(err){
    // fallback JSONP para evitar CORS
    console.warn('POST CORS falló, usando JSONP', err);
    const callbackName = 'cb_post_' + Math.random().toString(36).slice(2);
    window[callbackName] = function(data){
      if(data && data.status === 'ok'){ 
        alert('Horas registradas correctamente (JSONP).'); 
        obtenerDatosUsuario(); 
      } else {
        alert('Error al registrar horas (JSONP).');
      }
      delete window[callbackName]; script.remove();
    };
    const params = new URLSearchParams({
      action:'registrar',
      legajo: userLegajo,
      apellido, nombre,
      fecha, horas, lugar,
      callback: callbackName
    });
    const script = document.createElement('script');
    script.src = WEB_APP_URL + '?' + params.toString();
    document.body.appendChild(script);
  }
}


    // Panel supervisor: GET all
    async function verGeneral(){
      const key = document.getElementById('admin-key').value.trim();
      if(!key){ alert('Ingresa la clave de supervisor.'); return; }
      try {
        const res = await fetch(`${WEB_APP_URL}?action=getAll&key=${encodeURIComponent(key)}`, { method:'GET', mode:'cors' });
        const data = await res.json();
        if(data.status === 'unauthorized'){ alert('Clave incorrecta'); return; }
        if(data && data.status === 'ok'){
          const registros = data.registros || [];
          let html = '<table><tr><th>Legajo</th><th>Apellido</th><th>Nombre</th><th>Total</th><th>Restante</th></tr>';
          registros.forEach(r => {
            const restante = Math.max(0, LIMITE_HORAS - Number(r.total || 0));
            html += `<tr><td>${r.legajo}</td><td>${r.apellido}</td><td>${r.nombre}</td><td>${r.total}</td><td>${restante}</td></tr>`;
          });
          html += '</table>';
          document.getElementById('tabla-general').innerHTML = html;
        } else {
          alert('Respuesta inválida del servidor.');
        }
      } catch(err){
        console.error(err);
        alert('Error al obtener datos generales. Si ocurre por CORS, consulta configuración del GAS.');
      }
    }

    // Inicial: mostrar inicio
    mostrarInicio();
  </script>
</body>
</html>





